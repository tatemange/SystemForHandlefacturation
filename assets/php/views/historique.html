<div class="main-container">
  <h2 class="title">Historique des transactions & actions</h2>
  
  <div class="filters-container" style="display:flex; gap: 1rem; margin-bottom: 1rem; align-items: center; flex-wrap: wrap;">
    <!-- Filter by Entity Type -->
    <select id="filterEntity" style="padding: 0.5rem; border-radius: 5px; border: 1px solid #ccc;">
        <option value="">Toutes les entités</option>
        <option value="CLIENT">Clients</option>
        <option value="DOCUMENT">Documents</option>
        <option value="REGLEMENT">Règlements</option>
        <option value="SERVICE">Services</option>
    </select>
    
    <!-- Search Input -->
    <div class="search-box" style="position: relative;">
        <input type="text" id="searchHistory" placeholder="Rechercher..." class="search_h">
    </div>

    <button class="btn-primary btn-update" onclick="loadHistory()">Actualiser</button>
  </div>

  <div class="table-wrapper">
    <table class="table" id="historyTable">
      <thead>
        <tr>
          <th>Date</th>
          <th>Type d'Entité</th>
          <th>Action</th>
          <th>Détails</th>
          <th>Utilisateur (ID)</th>
          <th>View</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td colspan="6" style="text-align: center">Chargement...</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- HISTORY VIEW MODAL (Standardized) -->
<div id="historyModal" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeHistoryModal()">&times;</span>
        <h2 id="modalTitle" style="margin-bottom: 1.5rem;">Détails Historique</h2>
        
        <div id="modalContent">
             <!-- Content loaded via JS -->
             <p style="text-align:center;">Chargement...</p>
        </div>
        
        <div style="margin-top: 2rem; text-align: right; border-top: 1px solid var(--border-color); padding-top: 1rem;">
            <button id="btnPrintHistory" class="btn-primary" style="display:none; background-color: var(--btn-bg); color: var(--btn-color); border: var(--border); padding: 0.5rem 1.5rem; border-radius: 30px; cursor: pointer; margin-right: 10px;">Imprimer</button>
            <button class="btn-primary" onclick="closeHistoryModal()" style="background-color: var(--btn-bg); color: var(--btn-color); border: var(--border); padding: 0.5rem 1.5rem; border-radius: 30px; cursor: pointer;">Fermer</button>
        </div>
    </div>
</div>

<script>
    let currentOffset = 0;
    const LIMIT = 50;
    let isLoading = false;
    let hasMore = true;
    let searchMode = false;
    let observer = null;

    document.addEventListener("DOMContentLoaded", function () {
        const filterSelect = document.getElementById('filterEntity');
        filterSelect.addEventListener('change', () => resetAndLoad());
        
        // Search Input Logic
        const searchInput = document.getElementById('searchHistory');
        let debounceTimer;
        
        searchInput.addEventListener('input', (e) => {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                handleSearch(e.target.value);
            }, 300); // 300ms debounce
        });

        // Initialize Observer
        setupObserver();

        // Initial Load
        loadHistory(false);
        
        // Modal click outside to close
        window.onclick = function(event) {
            const modal = document.getElementById('historyModal');
            if (event.target == modal) {
                closeHistoryModal();
            }
        }
    });

    function setupObserver() {
        const options = {
            root: null,
            rootMargin: '0px',
            threshold: 1.0
        };
        
        observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting && !isLoading && hasMore && !searchMode) {
                    loadHistory(true); // Load next page
                }
            });
        }, options);
    }

    function handleSearch(term) {
        if (term.trim().length > 0) {
            searchMode = true;
            // Disable observer/infinite scroll visually or logic wise
            loadHistory(false, term);
        } else {
            searchMode = false;
            resetAndLoad();
        }
    }

    function resetAndLoad() {
        currentOffset = 0;
        hasMore = true;
        searchMode = false;
        document.querySelector("#historyTable tbody").innerHTML = "";
        loadHistory(false);
    }

    async function loadHistory(append = false, searchTerm = null) {
        if (isLoading) return;
        isLoading = true;

        const tbody = document.querySelector("#historyTable tbody");
        const filter = document.getElementById('filterEntity').value;
        const sentinel = document.getElementById('sentinel'); // We will add/manage this

        // Show loader if not appending (full reload)
        if (!append) {
             tbody.innerHTML = '<tr><td colspan="6" style="text-align: center"><i class="fa fa-spinner fa-spin"></i> Chargement...</td></tr>';
        } else {
             // Maybe show small loader at bottom?
        }

        let url = `assets/api/history_api.php?limit=${LIMIT}&offset=${currentOffset}`;
        
        if (searchTerm) {
            url = `assets/api/history_api.php?search=${encodeURIComponent(searchTerm)}`;
        } else if (filter) {
            url += `&entity_type=${filter}`;
        }

        try {
            const response = await fetch(url);
            const result = await response.json();

            // Clear loader if full reload
            if (!append) tbody.innerHTML = "";

            if (result.status === "success" && result.data.length > 0) {
                result.data.forEach((log) => {
                    let actionClass = "";
                    switch(log.action) {
                        case 'CREATE': actionClass = "badge-success"; break;
                        case 'UPDATE': actionClass = "badge-warning"; break;
                        case 'DELETE': actionClass = "badge-danger"; break;
                        default: actionClass = "badge-info";
                    }
                    
                    const dateObj = new Date(log.date_action);
                    const dateStr = dateObj.toLocaleString('fr-FR');

                    tbody.innerHTML += `
                        <tr class="history-row">
                            <td>${dateStr}</td>
                            <td><span class="tag">${log.entity_type}</span></td>
                            <td><span class="status-badge ${actionClass}" style="padding: 2px 8px; border-radius: 4px; font-size: 0.85em;">${log.action}</span></td>
                            <td>${log.details || '-'}</td>
                            <td>${log.user_id || 'Système'}</td>
                            <td>
                                ${ canView(log.entity_type, log.action) ? 
                                `<button class="btn-view" onclick="viewHistoryItem('${log.entity_type}', ${log.entity_id}, '${log.action}')" title="Voir le document">
                                    <i class="fa fa-eye"></i>
                                 </button>` : '<span style="color:#ccc">-</span>' 
                                }
                            </td>
                        </tr>`;
                });

                // Update Offset
                if (!searchMode) {
                    currentOffset += LIMIT;
                    if (result.data.length < LIMIT) hasMore = false;
                }
                
                // Manage Sentinel
                updateSentinel(tbody);

            } else {
                if (!append) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center">Aucun historique trouvé.</td></tr>';
                }
                hasMore = false;
            }
        } catch (error) {
            console.error(error);
            if (!append) tbody.innerHTML = '<tr><td colspan="6" style="color:red; text-align:center;">Erreur chargement.</td></tr>';
        } finally {
            isLoading = false;
        }
    }

    function updateSentinel(tbody) {
        // Remove existing sentinel
        const existing = document.getElementById('sentinel');
        if (existing) existing.remove();

        if (hasMore && !searchMode) {
            const sentinelRow = document.createElement('tr');
            sentinelRow.id = 'sentinel';
            sentinelRow.innerHTML = '<td colspan="6" style="text-align:center; padding:10px; color:#aaa">Chargement de la suite...</td>';
            tbody.appendChild(sentinelRow);
            observer.observe(sentinelRow);
        }
    }

    function canView(type, action) {
        if (action === 'DELETE') return false; // Deleted items usually can't be fetched
        return ['DOCUMENT', 'CLIENT', 'SERVICE'].includes(type);
    }

    function closeHistoryModal() {
        document.getElementById('historyModal').style.display = 'none';
        document.body.style.overflow = 'auto';
    }

    async function viewHistoryItem(type, id, action) {
        const modal = document.getElementById('historyModal');
        const content = document.getElementById('modalContent');
        const title = document.getElementById('modalTitle');
        const btnPrint = document.getElementById('btnPrintHistory');
        
        modal.style.display = 'flex';  /* Changed to flex for centering */ 
        document.body.style.overflow = 'hidden';
        content.innerHTML = '<div style="text-align:center; padding:2rem"><i class="fa fa-spinner fa-spin fa-2x"></i><br>Chargement des données...</div>';
        
        let typeLabel = type;
        if(type === 'DOCUMENT') typeLabel = 'Facture';
        
        title.textContent = `Détails : ${typeLabel} #${id}`;
        
        // Handle Print Button
        if (type === 'DOCUMENT') {
            btnPrint.style.display = 'inline-block';
            btnPrint.onclick = () => window.open(`print_invoice.php?id=${id}`, '_blank');
        } else {
            btnPrint.style.display = 'none';
        }

        let apiUrl = '';
        if (type === 'DOCUMENT') apiUrl = `assets/api/document_api.php?id=${id}`;
        else if (type === 'CLIENT') apiUrl = `assets/api/client_api.php?id=${id}`;
        else if (type === 'SERVICE') apiUrl = `assets/api/service_api.php?id=${id}`;
        
        if (!apiUrl) {
            content.innerHTML = '<p>Pas de vue détaillée disponible pour ce type.</p>';
            return;
        }

        try {
            const res = await fetch(apiUrl);
            const json = await res.json();

            if (json.status === 'success') {
                const data = json.data;
                renderEntityView(type, data, content);
            } else {
                content.innerHTML = `<p style="color:var(--error-color)">Erreur: ${json.message || 'Introuvable'}</p>`;
            }
        } catch (e) {
            content.innerHTML = `<p style="color:var(--error-color)">Erreur technique: ${e.message}</p>`;
        }
    }

    function renderEntityView(type, data, container) {
        let html = '';
        const gridStyle = 'display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;';
        const labelStyle = 'font-size: 0.85rem; color: var(--label-second); display: block; margin-bottom: 0.2rem;';
        const valueStyle = 'font-size: 1rem; font-weight: 500; word-break: break-word;';

        const createItem = (label, value, color) => `
            <div>
                <span style="${labelStyle}">${label}</span>
                <span style="${valueStyle} ${color ? 'color:' + color : ''}">${value || '-'}</span>
            </div>
        `;

        if (type === 'DOCUMENT') {
            const statusColor = data.status === 'PAYE' ? 'var(--success-color)' : (data.status === 'IMPAYE' ? 'var(--error-color)' : 'orange');
            
            html = `
                <div class="read-only-view">
                    <div style="${gridStyle}">
                        ${createItem('N° Facture', data.numero_d)}
                        ${createItem('Date', new Date(data.date_creation).toLocaleDateString('fr-FR'))}
                        ${createItem('Client', `${data.nom} ${data.prenom || ''}`)}
                        ${createItem('Montant', parseFloat(data.montant_total).toLocaleString('fr-FR') + ' FCFA')}
                        ${createItem('Statut', data.status, statusColor)}
                    </div>
                    
                    <h3 style="font-size: 1.1rem; margin-bottom: 0.5rem; border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem;">Lignes de la facture</h3>
                    <div class="table-wrapper" style="box-shadow: none; border: 1px solid var(--border-color); border-radius: var(--border-radius);">
                        <table class="table" style="width:100%; font-size:0.9rem; margin:0;">
                            <thead>
                                <tr style="background: var(--background-dark);">
                                    <th style="padding: 0.75rem;">Produit/Service</th>
                                    <th style="text-align:right; padding: 0.75rem;">Prix U.</th>
                                    <th style="text-align:center; padding: 0.75rem;">Qté</th>
                                    <th style="text-align:right; padding: 0.75rem;">Total</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            if (data.details && data.details.length > 0) {
                data.details.forEach(d => {
                    const lbl = d.libelle || d.libelle_produit || ('Item #' + d.id_service_produit);
                    html += `
                        <tr>
                            <td style="padding: 0.75rem;">${lbl}</td>
                            <td style="text-align:right; padding: 0.75rem;">${parseFloat(d.prix_unitaire).toLocaleString()}</td>
                            <td style="text-align:center; padding: 0.75rem;">${d.quantite}</td>
                            <td style="text-align:right; padding: 0.75rem;">${parseFloat(d.montant_ligne || d.montant || (d.prix_unitaire*d.quantite)).toLocaleString()} FCFA</td>
                        </tr>
                    `;
                });
            } else {
                html += '<tr><td colspan="4" style="text-align:center; padding:1rem">Aucun détail</td></tr>';
            }

            html += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        } 
        else if (type === 'CLIENT') {
            html = `
                <div class="read-only-view">
                    <div style="${gridStyle}">
                        ${createItem('Nom', data.nom)}
                        ${createItem('Prénom', data.prenom)}
                        ${createItem('Email', data.email)}
                        ${createItem('Téléphone', data.numero_telephone)}
                    </div>
                    <div style="border-top: 1px solid var(--border-color); padding-top: 1rem; ${gridStyle}">
                        ${createItem('Solde', data.solde + ' FCFA')}
                        ${createItem('Dette', data.dette + ' FCFA', 'var(--error-color)')}
                    </div>
                </div>
            `;
        }
        else if (type === 'SERVICE') {
             html = `
                <div class="read-only-view">
                    <div style="${gridStyle}">
                        ${createItem('Libellé', data.libelle)}
                        ${createItem('Type', data.est_service == 1 ? 'Service' : 'Produit')}
                        ${createItem('Prix Vente', data.prix_de_vente + ' FCFA')}
                        ${data.est_service == 0 ? createItem('Stock', data.quantite_stock) : ''}
                    </div>
                    <div style="margin-top:1rem;">
                        ${createItem('Description', data.description)}
                    </div>
                </div>
            `;
        }

        container.innerHTML = html;
    }
</script>

<style>
  /* Existing Styles Refinements */
  #filterEntity, .search_h, .btn-update {
    border: var(--border) !important;
    height: 36px;
    padding: 0 1rem;
    border-radius: 50px !important;
    background-color: transparent;
    outline: none;
    font-size: 1rem;
  }
  .filters-container .btn-primary {
    background-color: var(--first-color);
    color: white;
    padding: 0 1rem;
    border: none;
    border-radius: 40px;
    cursor: pointer;
  }
  #filterEntity option {
    background-color: var(--background) !important;
    color: var(--label) !important;
  }
  .badge-success { background-color: rgba(46, 221, 134, 0.2); color: var(--success-color); }
  .badge-warning { background-color: rgba(255, 193, 7, 0.2); color: #ffc107; }
  .badge-danger { background-color: rgba(233, 69, 69, 0.2); color: var(--error-color); }
  .badge-info { background-color: rgba(0, 100, 231, 0.2); color: var(--first-color); }
  
  .tag { font-weight: bold; font-size: 0.9em; opacity: 0.8; }
  
  .btn-view {
      background: none;
      border: none;
      color: var(--first-color);
      cursor: pointer;
      font-size: 1.1rem;
      transition: var(--t);
  }
  .btn-view:hover { opacity: 0.7; transform: scale(1.1); }

  table tr thead {
    background-color: var(--background-dark);
    color: var(--label);
  }
  
  /* Additional modal tweaks if needed */
  .modal-content {
      max-height: 85vh;
      overflow-y: auto;
  }

  /* CUSTOM OVERRIDES FOR HISTORY MODAL (Per User Request) */
  #historyModal {
      align-items: center;
      justify-content: center;
  }
  
  #historyModal .modal-content {
      background-color: var(--background); /* Use main background instead of reverse */
      color: var(--label);
      border: var(--border);
      width: 90%; 
      max-width: 500px; /* Don't fill the screen */
      box-shadow: 0 10px 40px rgba(0,0,0,0.5);
      
      /* User specific requests */
      padding: 1rem;
      border-radius: 16px;
      margin: 0; /* Reset global margin to allow flex centering */
  }
  
  #historyModal .close-modal {
      color: var(--label-second);
  }
  #historyModal .close-modal:hover {
      color: var(--first-color);
  }
</style>
