<!-- Lien CSS spécifique (si non inclus dans dashboard.php) -->
<link rel="stylesheet" href="assets/css/form.css" />

<!-- Zone de notifications Toast -->
<div id="notification-area"></div>

<div class="main-container">
  <!-- 1. TABLEAU DES CLIENTS -->
  <h2 class="title">Liste des clients</h2>
  <div class="table-wrapper">
    <table class="table" id="clientsTable">
      <thead>
        <tr>
          <th>Nom & Prénom</th>
          <th>Téléphone</th>
          <th>Email</th>
          <th>Solde</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <!-- Rempli par JS -->
        <tr>
          <td colspan="5">Chargement...</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- 2. FORMULAIRE D'AJOUT -->
  <form id="addClientForm" class="sign-in form" style="width: 100%">
    <fieldset style="box-shadow: none">
      <legend>Ajouter un client</legend>

      <div class="note">
        <p>
          Veuillez renseigner les informations correctes sur le client à
          enregistrer.
        </p>
      </div>

      <div class="doubleGroup">
        <div class="group" style="flex: 1">
          <label for="nom-cl">Nom</label>
          <input
            type="text"
            id="nom-cl"
            name="nom"
            maxlength="50"
            required
            placeholder=""
          />
        </div>
        <div class="group" style="flex: 1">
          <label for="prenom-cl">Prénom</label>
          <input
            type="text"
            id="prenom-cl"
            name="prenom"
            maxlength="50"
            placeholder=""
          />
        </div>
        <div class="group" style="flex: 1">
          <label for="phone-cl">Téléphone</label>
          <input
            type="tel"
            id="phone-cl"
            name="telephone"
            maxlength="20"
            placeholder=""
          />
        </div>
        <div class="group" style="flex: 1">
          <label for="email-cl">Email</label>
          <input
            type="email"
            id="email-cl"
            name="email"
            maxlength="100"
            placeholder=""
          />
        </div>
      </div>

      <!-- Boutons -->
      <div class="group-end" style="flex-direction: row">
        <button
          type="submit"
          class="btn-primary"
          style="padding: 0 1rem"
          id="btnSubmitClient"
        >
          Ajouter le client
        </button>
        <button type="reset" class="btn">Annuler</button>
      </div>
    </fieldset>
  </form>
</div>

<!-- 3. JAVASCRIPT NATIF (SANS JQUERY) -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // --- UTILS: TOAST NOTIFICATIONS ---
    function showNotification(message, type = "success") {
      const container = document.getElementById("notification-area");
      const toast = document.createElement("div");
      toast.className = `toast ${type}`;

      const icon = type === "success" ? "check-circle" : "exclamation-circle";

      toast.innerHTML = `
            <div class="toast-icon"><i class="fa fa-${icon}"></i></div>
            <div class="toast-message">${message}</div>
        `;

      container.appendChild(toast);

      // Auto remove après animation (4.5s)
      setTimeout(() => {
        toast.remove();
      }, 4500);
    }

    // --- FONCTION : Charger les clients ---
    async function loadClients() {
      const tbody = document.querySelector("#clientsTable tbody");

      try {
        const response = await fetch("assets/api/client_api.php");
        const result = await response.json();

        tbody.innerHTML = ""; // Vider le tableau

        if (result.status === "success" && result.data.length > 0) {
          result.data.forEach((client) => {
            tbody.innerHTML += `
                        <tr>
                            <td><strong>${client.nom}</strong> ${
              client.prenom || ""
            }</td>
                            <td>${client.numero_telephone || "-"}</td>
                            <td>${client.email || "-"}</td>
                            <td>${parseFloat(
                              client.solde
                            ).toLocaleString()} FCFA</td>
                            <td>
                                <button class="btn-sm" onclick="alert('Modification à venir')">Modifier</button>
                            </td>
                        </tr>`;
          });
        } else {
          tbody.innerHTML =
            '<tr><td colspan="5" style="text-align:center">Aucun client trouvé.</td></tr>';
        }
      } catch (error) {
        console.error(error);
        tbody.innerHTML =
          '<tr><td colspan="5" style="color:red; text-align:center;">Erreur de connexion serveur.</td></tr>';
        // showNotification('Impossible de charger les clients', 'error'); // Optionnel au chargement
      }
    }

    // --- EVENT : Soumission du formulaire ---
    document
      .getElementById("addClientForm")
      .addEventListener("submit", async function (e) {
        e.preventDefault(); // Empêche le rechargement de page

        const btnSubmit = document.getElementById("btnSubmitClient");
        const originalBtnText = btnSubmit.innerHTML;

        // Feedback UI : Chargement
        btnSubmit.disabled = true;
        btnSubmit.innerHTML =
          '<i class="fa fa-spinner fa-spin"></i> Traitement...';

        // Récupération des données
        const formData = {
          nom: document.getElementById("nom-cl").value,
          prenom: document.getElementById("prenom-cl").value,
          telephone: document.getElementById("phone-cl").value,
          email: document.getElementById("email-cl").value,
        };

        try {
          const response = await fetch("assets/api/client_api.php", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(formData),
          });

          const result = await response.json();

          if (result.status === "success") {
            showNotification("Client ajouté avec succès !", "success");
            this.reset(); // Vider le formulaire
            loadClients(); // Rafraîchir le tableau
          } else {
            showNotification(
              result.message || "Erreur lors de l'ajout",
              "error"
            );
          }
        } catch (error) {
          console.error(error);
          showNotification("Erreur technique de connexion.", "error");
        } finally {
          // Rétablir le bouton
          btnSubmit.disabled = false;
          btnSubmit.innerHTML = originalBtnText;
        }
      });

    // --- INITIALISATION ---
    loadClients();
  });
</script>
