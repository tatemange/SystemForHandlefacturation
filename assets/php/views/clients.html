<!-- Lien CSS spécifique (si non inclus dans dashboard.php) -->
<link rel="stylesheet" href="assets/css/form.css" />
<link rel="stylesheet" href="assets/css/clients.css" />

<!-- Zone de notifications Toast -->
<div id="notification-area"></div>

<div class="main-container">
  <!-- 1. TABLEAU DES CLIENTS -->
  <div class="clients-header">
      <h2 class="title">Liste des clients</h2>
      <input type="text" id="searchClients" placeholder="Rechercher un client..." class="clients-search-input">
  </div>
  <div class="table-wrapper">
    <table class="table" id="clientsTable">
      <thead>
        <tr>
          <th>Nom & Prénom</th>
          <th>Téléphone</th>
          <th>Email</th>
          <th>Solde</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <!-- Rempli par JS -->
        <tr>
          <td colspan="5">Chargement...</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- 2. FORMULAIRE D'AJOUT -->
  <form id="addClientForm" class="sign-in form form-full-width">
    <fieldset class="fieldset-no-shadow">
      <legend>Ajouter un client</legend>

      <div class="note">
        <p>
          Veuillez renseigner les informations correctes sur le client à
          enregistrer.
        </p>
      </div>

      <div class="doubleGroup">
        <div class="group flex-1">
          <label for="nom-cl">Nom</label>
          <input
            type="text"
            id="nom-cl"
            name="nom"
            maxlength="50"
            required
            placeholder=""
          />
        </div>
        <div class="group flex-1">
          <label for="prenom-cl">Prénom</label>
          <input
            type="text"
            id="prenom-cl"
            name="prenom"
            maxlength="50"
            placeholder=""
          />
        </div>
        <div class="group flex-1">
          <label for="phone-cl">Téléphone</label>
          <input
            type="tel"
            id="phone-cl"
            name="telephone"
            maxlength="20"
            placeholder=""
          />
        </div>
        <div class="group flex-1">
          <label for="email-cl">Email</label>
          <input
            type="email"
            id="email-cl"
            name="email"
            maxlength="100"
            placeholder=""
          />
        </div>
      </div>

      <!-- Boutons -->
      <div class="group-end group-row">
        <button
          type="submit"
          class="btn-primary btn-padding"
          id="btnSubmitClient"
        >
          Ajouter le client
        </button>
        <button type="reset" class="btn">Annuler</button>
      </div>
    </fieldset>
  </form>
  <!-- 4. MODAL MODIFICATION CLIENT -->
  <div id="editClientModal" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="close-modal" onclick="closeEditModal()">&times;</span>
        <h2>Modifier Client</h2>
        <form id="editClientForm" class="form form-modal-edit">
            <input type="hidden" id="edit-id-cl">
            <div class="group">
                <label for="edit-nom-cl">Nom</label>
                <input type="text" id="edit-nom-cl" required>
            </div>
            <div class="group">
                <label for="edit-prenom-cl">Prénom</label>
                <input type="text" id="edit-prenom-cl">
            </div>
            <div class="group">
                <label for="edit-phone-cl">Téléphone</label>
                <input type="tel" id="edit-phone-cl">
            </div>
            <div class="group">
                <label for="edit-email-cl">Email</label>
                <input type="email" id="edit-email-cl">
            </div>
            <div class="group-end modal-actions">
                <button type="submit" class="btn-primary" id="btnUpdateClient">Enregistrer les modifications</button>
                <button type="button" class="btn" onclick="closeEditModal()">Annuler</button>
            </div>
        </form>
    </div>
  </div>

</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        // Initialize Search for Clients
        filterTable('searchClients', 'clientsTable');
    });
</script>

<!-- 3. JAVASCRIPT NATIF (SANS JQUERY) -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // --- UTILS: TOAST NOTIFICATIONS ---
    function showNotification(message, type = "success") {
      const container = document.getElementById("notification-area");
      const toast = document.createElement("div");
      toast.className = `toast ${type}`;

      const icon = type === "success" ? "check-circle" : "exclamation-circle";

      toast.innerHTML = `
            <div class="toast-icon"><i class="fa fa-${icon}"></i></div>
            <div class="toast-message">${message}</div>
        `;

      container.appendChild(toast);

      // Auto remove après animation (4.5s)
      setTimeout(() => {
        toast.remove();
      }, 4500);
    }

    // --- GLOBALS ---
    window.closeEditModal = function() {
        document.getElementById('editClientModal').style.display = "none";
    }

    window.openEditModal = function(clientData) {
        // Decode logic if passed as base64 or stored object. 
        // Simpler: pass ID and fetch or pass individual fields.
        // For simplicity here, we will attach data to button in loadClients.
        
        document.getElementById('edit-id-cl').value = clientData.id;
        document.getElementById('edit-nom-cl').value = clientData.nom;
        document.getElementById('edit-prenom-cl').value = clientData.prenom || '';
        document.getElementById('edit-phone-cl').value = clientData.numero_telephone || '';
        document.getElementById('edit-email-cl').value = clientData.email || '';

        document.getElementById('editClientModal').style.display = "flex";
    }

    // --- FONCTION : Charger les clients ---
    async function loadClients() {
      const tbody = document.querySelector("#clientsTable tbody");

      try {
        const response = await fetch("assets/api/client_api.php");
        const result = await response.json();

        tbody.innerHTML = ""; // Vider le tableau

        if (result.status === "success" && result.data.length > 0) {
          result.data.forEach((client) => {
            // Escape quotes for onclick JSON
            const clientJson = JSON.stringify(client).replace(/"/g, '&quot;');
            
            tbody.innerHTML += `
                        <tr>
                            <td><strong>${client.nom}</strong> ${
              client.prenom || ""
            }</td>
                            <td>${client.numero_telephone || "-"}</td>
                            <td>${client.email || "-"}</td>
                            <td>${parseFloat(
                              client.solde
                            ).toLocaleString()} FCFA</td>
                            <td>
                                <button class="btn-sm" onclick="openEditModal(${clientJson})">Modifier</button>
                            </td>
                        </tr>`;
          });
        } else {
          tbody.innerHTML =
            '<tr><td colspan="5" style="text-align:center">Aucun client trouvé.</td></tr>';
        }
      } catch (error) {
        console.error(error);
        tbody.innerHTML =
          '<tr><td colspan="5" style="color:red; text-align:center;">Erreur de connexion serveur.</td></tr>';
        // showNotification('Impossible de charger les clients', 'error'); // Optionnel au chargement
      }
    }

    // --- EVENT : Soumission du formulaire d'AJOUT ---
    document
      .getElementById("addClientForm")
      .addEventListener("submit", async function (e) {
        e.preventDefault(); // Empêche le rechargement de page

        const btnSubmit = document.getElementById("btnSubmitClient");
        const originalBtnText = btnSubmit.innerHTML;

        // Feedback UI : Chargement
        btnSubmit.disabled = true;
        btnSubmit.innerHTML =
          '<i class="fa fa-spinner fa-spin"></i> Traitement...';

        // Récupération des données
        const formData = {
          nom: document.getElementById("nom-cl").value,
          prenom: document.getElementById("prenom-cl").value,
          telephone: document.getElementById("phone-cl").value,
          email: document.getElementById("email-cl").value,
        };

        try {
          const response = await fetch("assets/api/client_api.php", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(formData),
          });

          const result = await response.json();

          if (result.status === "success") {
            showNotification("Client ajouté avec succès !", "success");
            this.reset(); // Vider le formulaire
            loadClients(); // Rafraîchir le tableau
          } else {
            showNotification(
              result.message || "Erreur lors de l'ajout",
              "error"
            );
          }
        } catch (error) {
          console.error(error);
          showNotification("Erreur technique de connexion.", "error");
        } finally {
          // Rétablir le bouton
          btnSubmit.disabled = false;
          btnSubmit.innerHTML = originalBtnText;
        }
      });
      
    // --- EVENT : Soumission du formulaire de MODIFICATION ---
    document.getElementById("editClientForm").addEventListener("submit", async function(e) {
        e.preventDefault();
        
        const btnSubmit = document.getElementById("btnUpdateClient");
        const originalText = btnSubmit.innerHTML;
        btnSubmit.disabled = true;
        btnSubmit.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Enregistrement...';
        
        const formData = {
            id: document.getElementById("edit-id-cl").value,
            nom: document.getElementById("edit-nom-cl").value,
            prenom: document.getElementById("edit-prenom-cl").value,
            telephone: document.getElementById("edit-phone-cl").value,
            email: document.getElementById("edit-email-cl").value
        };
        
        try {
            const response = await fetch("assets/api/client_api.php", {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(formData)
            });
            
            const result = await response.json();
            
            if (result.status === "success") {
                showNotification("Client mis à jour avec succès !", "success");
                closeEditModal();
                loadClients();
            } else {
                showNotification(result.message || "Erreur de mise à jour", "error");
            }
        } catch(error) {
             console.error(error);
             showNotification("Erreur technique.", "error");
        } finally {
            btnSubmit.disabled = false;
            btnSubmit.innerHTML = originalText;
        }
    });

    // --- INITIALISATION ---
    loadClients();
  });
</script>
